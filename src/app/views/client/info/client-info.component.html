<div class="center">
  <form #formInfo="ngForm" (submit)="onSubmit(formInfo)">
    <mat-toolbar>
      <!--<mat-card-title>-->
      <a mat-icon-button type="button" [disabled]="loading" routerLink="/client" matTooltip="Ir para lista"
         matTooltipPosition="below">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <span *ngIf="!info.id">Novo cliente</span>
      <span *ngIf="info.id" [title]="info.name" class="ellipsis">
          {{(info.name?.length > 40 ? (info.name | slice:0:40) + '...' : info.name)}}
        </span>
      <span style="flex: 1"></span>
      <button mat-icon-button type="button" *ngIf="info.id" [matMenuTriggerFor]="removeMenu" [disabled]="loading"
              matTooltip="Excluir cliente" matTooltipPosition="below">
        <mat-icon>delete</mat-icon>
      </button>
      <mat-menu #removeMenu="matMenu">
        <div class="mat-menu-header">Você realmente deseja excluir?</div>
        <button mat-menu-item (click)="remove()">Sim</button>
        <button mat-menu-item>Não</button>
      </mat-menu>
      <!--</mat-card-title>-->
    </mat-toolbar>
    <mat-accordion>
      <mat-expansion-panel #expansionOne [expanded]="true">
        <mat-progress-bar mode="query" [class.show]="loading"></mat-progress-bar>
        <mat-expansion-panel-header>
          <mat-panel-title>
            Informações <i *ngIf="!expansionOne.expanded && formInfo.dirty && formInfo.touched && formInfo.invalid">contém
            campo
            inválido</i>
          </mat-panel-title>
        </mat-expansion-panel-header>
        <p>
          <mat-form-field appearance="fill">
            <mat-label>Nome</mat-label>
            <input matInput #nameField="ngModel" name="name" [(ngModel)]="info.name" type="text" required
                   maxlength="100"
                   [disabled]="loading">
            <mat-hint align="end" *ngIf="info.name?.length >= 100">{{info.name?.length || 0}}/100</mat-hint>
            <mat-error *ngIf="nameField.hasError('required')">
              Preencha com o nome
            </mat-error>
          </mat-form-field>
        </p>
        <p>
          <mat-form-field appearance="fill">
            <mat-label>Documento</mat-label>
            <input matInput #documentField="ngModel" name="document" [(ngModel)]="info.document" type="text"
                   maxlength="20" placeholder="CPF ou CNPJ" [disabled]="loading">
            <mat-hint align="end" *ngIf="info.document?.length >= 20">
              {{info.document?.length || 0}}/20
            </mat-hint>
          </mat-form-field>
        </p>
        <p>
          <mat-form-field appearance="fill">
            <mat-label>Descrição</mat-label>
            <textarea matInput #descriptionField="ngModel" name="description" [(ngModel)]="info.description"
                      maxlength="200" [disabled]="loading" autosize></textarea>
            <mat-hint align="end">
              {{info.description?.length || 0}}/200
            </mat-hint>
          </mat-form-field>
        </p>
      </mat-expansion-panel>
      <mat-expansion-panel>
        <mat-progress-bar mode="query" [class.show]="loadingZipCode"></mat-progress-bar>
        <mat-expansion-panel-header>
          <mat-panel-title>
            Endereço
          </mat-panel-title>
        </mat-expansion-panel-header>
        <p>
          <mat-form-field appearance="fill">
            <mat-label>CEP</mat-label>
            <input matInput #zipCodeFieldEl #zipCodeField="ngModel" name="zipCode" [(ngModel)]="info.address.zipCode"
                   type="tel" mask="00000-000" [disabled]="loading || loadingZipCode">
            <button mat-icon-button type="button" matSuffix
                    (click)="searchZipCode(info.address.zipCode, numberFieldEl, zipCodeFieldEl)"
                    [disabled]="loading || loadingZipCode"
                    matTooltip="Buscar informações do endereço" matTooltipPosition="above">
              <mat-icon>search</mat-icon>
            </button>
            <mat-error *ngIf="zipCodeField.hasError('mask')">
              Preencha com um CEP válido
            </mat-error>
          </mat-form-field>
        </p>
        <p>
          <mat-form-field appearance="fill">
            <mat-label>Rua</mat-label>
            <input matInput #streetField="ngModel" name="street" [(ngModel)]="info.address.street" maxlength="200"
                   type="text" [disabled]="loading || loadingZipCode">
            <mat-hint align="end" *ngIf="info.address.street?.length >= 200">
              {{info.address.street?.length || 0}}/200
            </mat-hint>
          </mat-form-field>
        </p>
        <p>
          <mat-form-field appearance="fill">
            <mat-label>Número</mat-label>
            <input matInput #numberFieldEl #numberField="ngModel" name="number" [(ngModel)]="info.address.number"
                   maxlength="20"
                   type="text" [disabled]="loading">
            <mat-hint align="end" *ngIf="info.address.number?.length >= 20">
              {{info.address.number?.length || 0}}/20
            </mat-hint>
          </mat-form-field>
        </p>
        <p>
          <mat-form-field appearance="fill">
            <mat-label>Complemento</mat-label>
            <input matInput #complementField="ngModel" name="complement" [(ngModel)]="info.address.complement"
                   maxlength="200"
                   type="text" [disabled]="loading || loadingZipCode">
            <mat-hint align="end" *ngIf="info.address.complement?.length >= 200">
              {{info.address.complement?.length || 0}}/200
            </mat-hint>
          </mat-form-field>
        </p>
        <p>
          <mat-form-field appearance="fill">
            <mat-label>Bairro</mat-label>
            <input matInput #districtField="ngModel" name="district" [(ngModel)]="info.address.district" maxlength="50"
                   type="text" [disabled]="loading || loadingZipCode">
            <mat-hint align="end" *ngIf="info.address.district?.length >= 50">
              {{info.address.district?.length || 0}}/50
            </mat-hint>
          </mat-form-field>
        </p>
        <p>
          <mat-form-field appearance="fill">
            <mat-label>Cidade</mat-label>
            <input matInput #cityField="ngModel" name="city" [(ngModel)]="info.address.city" maxlength="50"
                   type="text" [disabled]="loading || loadingZipCode">
            <mat-hint align="end" *ngIf="info.address.city?.length >= 50">
              {{info.address.city?.length || 0}}/50
            </mat-hint>
          </mat-form-field>
        </p>
        <p>
          <mat-form-field appearance="fill">
            <mat-label>Estado</mat-label>
            <!--<input matInput #stateField="ngModel" name="state" [(ngModel)]="info.address.state" maxlength="50"
                   type="text" [disabled]="loading || loadingZipCode">-->
            <mat-select [(value)]="info.address.state" [disabled]="loading || loadingZipCode">
              <mat-option *ngFor="let state of states" [value]="state.uf">
                {{state.name}}
              </mat-option>
            </mat-select>
            <mat-hint align="end" *ngIf="info.address.state?.length >= 50">
              {{info.address.state?.length || 0}}/50
            </mat-hint>
          </mat-form-field>
        </p>
      </mat-expansion-panel>
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            Telefones
          </mat-panel-title>
        </mat-expansion-panel-header>
        <p *ngFor="let phone of info.phones; let i = index">
          <mat-form-field appearance="fill">
            <mat-label>Telefone</mat-label>
            <input matInput #phoneNumberField="ngModel" [name]="'phoneNumber' + i" [(ngModel)]="phone.number"
                   type="text" maskPhone [disabled]="loading">
            <button mat-icon-button type="button" matSuffix class="show-on-hover" (click)="info.phones.splice(i, 1)"
                    matTooltip="Remover telefone" matTooltipPosition="above">
              <mat-icon>delete</mat-icon>
            </button>
          </mat-form-field>
        </p>
        <p>
          <mat-form-field appearance="fill">
            <mat-label>Novo telefone</mat-label>
            <input matInput #newPhoneNumberField="ngModel" name="newPhoneNumber"
                   [(ngModel)]="info.phones.newPhone.number"
                   type="text" [disabled]="loading" maskPhone>
            <button mat-icon-button type="button" matSuffix
                    (click)="this.info.phones.push(this.info.phones.newPhone); this.info.phones.newPhone = {}"
                    matTooltip="Adicionar telefone" matTooltipPosition="above">
              <!--TODO: Still not removing-->
              <mat-icon>add</mat-icon>
            </button>
          </mat-form-field>
        </p>
      </mat-expansion-panel>
      <mat-expansion-panel #expansionFour>
        <mat-expansion-panel-header>
          <mat-panel-title>
            E-mails <i *ngIf="checkExpansionInvalid(expansionFour)">contém campo inválido</i>
            <!--TODO: Problema do changed before checked-->
          </mat-panel-title>
        </mat-expansion-panel-header>

        <smart-list #emailList [model]="info.emails">
          <smart-list-item *ngFor="let email of emailList.list; let i = index;">
            <p>
              <mat-form-field appearance="fill">
                <mat-label>E-mail</mat-label>
                <input matInput #emailField="ngModel" [name]="'email' + i" [(ngModel)]="email.email"
                       type="email" [disabled]="loading" [email]="true">
                <mat-error *ngIf="emailField.hasError('email')">
                  Preencha com um e-mail <strong>válido</strong>
                </mat-error>
                <button mat-icon-button type="button" matSuffix class="show-on-hover"
                        *ngIf="i < emailList.list.length - 1" (click)="emailList.remove(i);"
                        matTooltip="Remover e-mail" matTooltipPosition="above">
                  <mat-icon>delete</mat-icon>
                </button>
              </mat-form-field>
            </p>
          </smart-list-item>
        </smart-list>

        <!--<p *ngFor="let email of info.emails; let i = index">
          <mat-form-field appearance="fill">
            <mat-label>E-mail</mat-label>
            <input matInput #emailField="ngModel" [name]="'email' + i" [(ngModel)]="email.email"
                   type="email" [disabled]="loading" [email]="true">
            <mat-error *ngIf="emailField.hasError('email')">
              Preencha com um e-mail <strong>válido</strong>
            </mat-error>
            <button mat-icon-button type="button" matSuffix class="show-on-hover" (click)="info.emails.splice(i, 1)"
                    matTooltip="Remover e-mail" matTooltipPosition="above">
              <mat-icon>delete</mat-icon>
            </button>
          </mat-form-field>
        </p>
        <p>
          <mat-form-field appearance="fill">
            <mat-label>Novo e-mail</mat-label>
            <input matInput #newEmailField="ngModel" name="newEmail" [(ngModel)]="info.emails.newEmail.email"
                   type="email" [disabled]="loading" [email]="true">
            <mat-error *ngIf="newEmailField.hasError('email')">
              Preencha com um e-mail <strong>válido</strong>
            </mat-error>
            <button mat-icon-button type="button" matSuffix
                    (click)="this.info.emails.push(this.info.emails.newEmail); this.info.emails.newEmail = {}"
                    matTooltip="Adicionar e-mail" matTooltipPosition="above">
              <mat-icon>add</mat-icon>
            </button>
          </mat-form-field>
        </p>-->
      </mat-expansion-panel>
    </mat-accordion>

    <mat-toolbar *ngIf="!appComponent.mobileQuery.matches">
      <span style="flex: 1"></span>
      <button mat-raised-button color="success" [disabled]="loading">{{!info.id ? 'ADICIONAR' : 'SALVAR'}}</button>
    </mat-toolbar>

    <mat-card class="manut mat-elevation-z0" *ngIf="info.createdBy">
      Criado por {{info.createdBy}} em
      <span [title]="info.creationDate | date : 'full'">{{info.creationDate | date : 'medium'}}</span>
      <span *ngIf="info.updatedBy">
            <br>Alterado por {{info.updatedBy}} em
            <span [title]="info.lastUpdateDate | date : 'full'">{{info.lastUpdateDate | date : 'medium'}}</span>
          </span>
    </mat-card>

    <pre>{{info | json}}</pre>
  </form>
</div>

<div class="fab-container-space" *ngIf="appComponent.mobileQuery.matches"></div>

<app-fnls-displacer>
  <div class="fab-container" *ngIf="appComponent.mobileQuery.matches">
    <button mat-fab color="success" (click)="onSubmit(formInfo)" [disabled]="loading">
      <i class="material-icons">check</i>
    </button>
  </div>
</app-fnls-displacer>
